## 등록/수정/조회 API 만들기

API를 만들기 위해서는 총 3개의 클래스가 필요하다.

- Request 데이터를 받을 DTO
- API 요청을 받을 Controller
- 트랜잭션, 도메인 기능 간의 순서를 보장하는 Service

우리는 흔히 비즈니스 로직을 처리하는 부분은 Service라는 오해를 하고 있는데, 아래 Spring 웹 계층을 보면서 오해를 풀 수 있다.

<img src="https://user-images.githubusercontent.com/40616436/99390997-d556f100-291c-11eb-8e88-419be113fb11.png" alt="image" style="zoom:50%;" />

- Web Layer
  - 흔히 우리가 사용하는 Controller, JSP 등의 뷰 템플릿 영역이다.
  - 이외에도 필터(@Filter), 인터셉터, @ControllerAdvice 등 **외부 요청과 응답**에 대한 전반적인 영역을 이야기한다.
- Service Layer
  - @Service에 사용되는 서비스 영역이다.
  - 일반적으로 Controller와 Dao의 중간 영역에서 사용된다.
  - @Transaction이 사용되어야 하는 영역이다.
- Repository Layer
  - Database와 같이 데이터 저장소에 접근하는 영역이다.
  - Dao(data access object) 영역으로 이해할 수 있다.
- DTOs
  - DTO(Data Transfer Object)는 **계층 간에 데이터 교환을 위한 객체**를 이야기하며 DTOs는 이들의 영역을 말한다.
  - 예를 들어, 뷰 템플릿 엔진에서 사용될 객체나 Repository Layer에서 결과로 넘겨준 객체 등을 말한다.
- Domain Model
  - 도메인이라 불리는 개발 대상을 모든 사람이 동일한 관점에서 이해할 수 있고 공유할 수 있도록 단순화시킨 것을 도메인 모델이라고 한다.
    - 예를 들어, 택시 앱이라고 하면 **배차, 탑승, 요금** 등이 모두 도메인이 될 수 있다.
  - @Entity가 사용된 영역이 도메인 모델이라고 이해하면 된다.
  - 다만, 무조건 데이터베이스 테이블과 관계가 있어야 하는 것은 아니고, VO와 같이 값 객체들도 이 영역에 해당할 수 있다.

그럼, Web, Service, Repository, Dao, Domain 중 비즈니스를 처리해야하는 곳은 어디일까? **바로 Domain이다.** 

그럼 우리가 기존에 서비스를 처리하던 방식은 무엇인가? 그것은 트랜잭션 스크립트 방식으로 표현한다.



### 트랜잭션 스크립트

우리가 기존에 로직을 서비스에서 처리하던 방식은 ***트랜잭션 스크립트*** 라고 표현한다. 예를들어, 주문 취소 로직을 구현한다고 생각해보자.

~~~
1. 데이터베이스로부터 주문정보(Orders), 결제정보(Biiling), 배송정보(Delivery) 조회
2. 배송 취소를 해야하는지 확인
3. 배송중이라면 배송 취소로 변경
4. 각 테이블에 취소 상태 Update
~~~

~~~java
//실제 코드
public Order cancelOrder(int orderId) {
  //1)
  OrdersDto order = ordersDao.selectOrders(orderId);
  BillingDto billing = billingDao.selectBilling(orderId);
  DeliveryDto delivery = deliveryDao.selectDelivery(orderId);

  //2)
  String deliveryStatus = delivery.getStatus();

  //3)
  if("IN_PROGRESS".equals(deliveryStatus)) {
    delivery.setStatus("CANCEL");
    deliveryDao.update(delivery);
  }

  //4)
  order.setStatus("CANCEL");
  orderDao.update(order);

  billing.setStatus("CANCEL");
  deliveryDao.update(billing);

  return order;
}
~~~

